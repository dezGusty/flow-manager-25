@using FlowManager.Shared.DTOs.Responses.Step
@using FlowManager.Shared.DTOs.Requests.FormResponse
@using FlowManager.Shared.DTOs.Responses.FlowStep

<div class="flow-visualizer">
    <div class="flow-header">
        <h5>Workflow Progress</h5>
    </div>

    @if (IsLoading)
    {
        <div class="flow-loading">
            <div class="spinner-small"></div>
            <span>Loading workflow...</span>
        </div>
    }
    else if (FlowSteps?.Any() == true && FormResponse != null)
    {
        <div class="flow-container">
            @for (int i = 0; i < FlowSteps.Count; i++)
            {
                var currentFlowStep = FlowSteps[i];
                var stepStatus = GetStepStatus(currentFlowStep, i);
                var isLastStep = i == FlowSteps.Count - 1;

                string flowStepItemsNames = string.Join("/", currentFlowStep.FlowStepItems.Select(fsi => fsi.Step.StepName));

                <div class="step-wrapper">
                    <!-- Step Circle -->
                    <div class="step-circle @GetStepStatusClass(stepStatus)"
                         title="Step @(i + 1)">
                        <!-- DE SCHIMBAT-->
                        <span class="step-initials">Step @(i + 1)</span>
                    </div>

                    <!-- Step Label -->
                    <div class="step-label">
                        <span class="step-name">@flowStepItemsNames</span>
                        <span class="step-status">@GetStepStatusText(stepStatus)</span>
                    </div>

                    <!-- Connection Line (nu pentru ultimul step) -->
                    @if (!isLastStep)
                    {
                        <div class="flow-connector @GetConnectorClass(stepStatus)"></div>
                    }
                </div>
            }
        </div>

        <!-- Status Legend -->
        <div class="flow-legend">
            <div class="legend-item">
                <div class="legend-circle pending"></div>
                <span>Current Step</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle completed"></div>
                <span>Completed</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle rejected"></div>
                <span>Rejected</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle inactive"></div>
                <span>Not Started</span>
            </div>
        </div>
    }
    else if (!IsLoading)
    {
        <div class="flow-error">
            <span>Unable to load workflow information</span>
        </div>
    }
</div>

@code {
    [Parameter] public List<FlowStepResponseDto>? FlowSteps { get; set; }
    [Parameter] public FormResponseResponseDto? FormResponse { get; set; }
    [Parameter] public bool IsLoading { get; set; } = false;

    private bool isPendingStepSet { get; set; } = false;

    public enum StepStatus
    {
        Inactive,    // Gri - nu s-a ajuns încă la acest step
        Pending,     // Galben - step-ul curent în așteptare
        Completed,   // Verde - step-ul a fost completat/aprobat
        Rejected     // Roșu - step-ul a fost respins
    }

    private StepStatus GetStepStatus(FlowStepResponseDto flowStep, int flowStepIndex)
    {
        if (FormResponse == null || FlowSteps == null) return StepStatus.Inactive;

        if (flowStep.IsApproved.HasValue)
        {
            return flowStep.IsApproved.Value ? StepStatus.Completed : StepStatus.Rejected;
        }

        bool allPreviousCompleted = true;
        for (int i = 0; i < flowStepIndex; i++)
        {
            if (!FlowSteps[i].IsApproved.HasValue || !FlowSteps[i].IsApproved.Value)
            {
                allPreviousCompleted = false;
                break;
            }
        }

        return allPreviousCompleted ? StepStatus.Pending : StepStatus.Inactive;
    }

    private string GetStepStatusClass(StepStatus status)
    {
        return status switch
        {
            StepStatus.Pending => "pending",
            StepStatus.Completed => "completed",
            StepStatus.Rejected => "rejected",
            StepStatus.Inactive => "inactive",
            _ => "inactive"
        };
    }

    private string GetStepStatusText(StepStatus status)
    {
        return status switch
        {
            StepStatus.Pending => "Pending",
            StepStatus.Completed => "Completed",
            StepStatus.Rejected => "Rejected",
            StepStatus.Inactive => "Not Started",
            _ => "Unknown"
        };
    }

    private string GetConnectorClass(StepStatus currentStepStatus)
    {
        // Conectorul este activ doar dacă step-ul curent e completat
        return currentStepStatus == StepStatus.Completed ? "active" : "inactive";
    }

    private string GetStepInitials(string? stepName)
    {
        if (string.IsNullOrWhiteSpace(stepName))
            return "??";

        stepName = stepName.Trim();

        // Împarte în cuvinte
        var words = stepName.Split(new char[] { ' ', '-', '_' }, StringSplitOptions.RemoveEmptyEntries);

        if (words.Length == 1)
        {
            // Un singur cuvânt - ia primele 2 litere
            return stepName.Length >= 2 ? stepName.Substring(0, 2).ToUpper() : stepName.ToUpper();
        }
        else
        {
            // Mai multe cuvinte - ia prima literă din fiecare cuvânt (max 3)
            var initials = string.Join("", words.Take(3).Select(w => w.Length > 0 ? w[0].ToString() : ""));
            return initials.ToUpper();
        }
    }
}