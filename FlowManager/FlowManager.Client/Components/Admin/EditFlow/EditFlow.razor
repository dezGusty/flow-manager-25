@using FlowManager.Client.Components.Admin.Flows.AddFlow.FlowAddModal;
@using FlowManager.Client.ViewModels;
@using Microsoft.AspNetCore.Components.Web;

<div class="add-flow-container">
    @if (_showAssignToStepModal)
    {
        <AssignToStepModal @bind-ShowAssignToStepModal="@_showAssignToStepModal"
                           @bind-FlowStepItemToAssign="@_flowStepItemToAssign"
                           OnFlowStepItemAssigned="ConfigureStepsToFlow"/>
    }

    <!-- Step configuration area -->
    <div class="step-configuration @(_isDragOver ? "drag-over" : "")"
         @ondrop="HandleDrop"
         @ondragover="HandleDragOver"
         @ondragover:preventDefault="true"
         @ondragenter="HandleDragEnter"
         @ondragleave="HandleDragLeave">

        <div class="step-configuration-header">
            <div class="flow-name-section">
                <div class="flow-name-row">
                    <div class="flow-name-input-group">
                        <label for="flowName" class="flow-name-label">Flow Name (must be different from @_initialFlowName):</label>
                        <input type="text"
                               id="flowName"
                               class="flow-name-input @GetFlowNameValidationClass()"
                               placeholder="*Enter workflow name..."
                               @bind="_flowName"
                               @bind:event="oninput"
                               maxlength="100" />
                    </div>
                    <button class="btn-add-flowstep" @onclick="AddFlowStep">
                        + Add Flow Step
                    </button>
                </div>
            </div>
        </div>

        <div class="dropped-steps">
            @if (!_configuredSteps.Any())
            {
                <div class="empty-state">
                    Click "Add Flow Step" to create workflow steps, then drag available steps to assign them
                </div>
            }
            else
            {
                @for (int i = 0; i < _configuredSteps.Count; i++)
                {
                    var flowStep = _configuredSteps[i];
                    var flowStepIndex = i;

                    <!-- FlowStep container -->
                    <div class="dropped-step flowstep-droppable @(_isDragOverFlowStep == flowStepIndex ? "drag-over-flowstep" : "")"
                         key="@flowStep.Id"
                         @ondrop="(e) => HandleDropOnFlowStep(e, flowStepIndex)"
                         @ondragover="(e) => HandleDragOverFlowStep(e, flowStepIndex)"
                         @ondragover:preventDefault="true"
                         @ondragenter="(e) => HandleDragEnterFlowStep(e, flowStepIndex)"
                         @ondragleave="(e) => HandleDragLeaveFlowStep(e, flowStepIndex)">

                        <!-- FlowStep header -->
                        <div class="flowstep-header">

                            <!-- FlowStep title -->
                            <div class="flowstep-title">Flow Step @(flowStepIndex + 1)</div>

                            <!-- FlowStep controls -->
                            <div class="flowstep-controls">
                                <!-- FlowStep reorder buttons -->
                                <div class="reorder-buttons flowstep-reorder">
                                    @if (flowStepIndex > 0)
                                    {
                                        <button class="reorder-btn up" @onclick="() => MoveStepUp(flowStepIndex)" title="Move flow step up" @onclick:stopPropagation="true">↑</button>
                                    }
                                    @if (flowStepIndex < _configuredSteps.Count - 1)
                                    {
                                        <button class="reorder-btn down" @onclick="() => MoveStepDown(flowStepIndex)" title="Move flow step down" @onclick:stopPropagation="true">↓</button>
                                    }
                                </div>

                                <!-- Remove FlowStep button -->
                                <button class="remove-step flowstep-remove" @onclick="() => RemoveConfiguredStep(flowStepIndex)" @onclick:stopPropagation="true">×</button>
                            </div>
                        </div>

                        <!-- FlowStepItems container -->
                        <div class="flowstep-items-container">
                            @if (!flowStep.FlowStepItems.Any())
                            {
                                <div class="flowstep-items-empty">
                                    <span class="empty-text">Drag steps here to assign them to this flow step</span>
                                </div>
                            }
                            else
                            {
                                @for (int j = 0; j < flowStep.FlowStepItems.Count; j++)
                                {
                                    var flowStepItem = flowStep.FlowStepItems[j];
                                    var flowStepItemIndex = j;

                                    <!-- FlowStepItem -->
                                    <div class="flowstep-item" @onclick="() => ShowAssingToStepModal(flowStepItem, flowStepIndex, flowStepItemIndex)">

                                        <!-- FlowStepItem content -->
                                        <div class="flowstepitem-info">
                                            <div class="step-avatar flowstepitem-avatar">
                                                @if (flowStepItem.Step?.Name != null)
                                                {
                                                    @flowStepItem.Step.Name.Substring(0, Math.Min(2, flowStepItem.Step.Name.Length)).ToUpper()
                                                }
                                                else
                                                {
                                                    <text>?</text>
                                                }
                                            </div>
                                            <div class="step-details flowstepitem-details">
                                                <div class="step-name">@(flowStepItem.Step?.Name ?? "Unassigned Step")</div>
                                                <div class="step-users-count">
                                                    @((flowStepItem.AssignedUsers?.Count ?? 0) + (flowStepItem.AssignedTeams?.Count ?? 0)) assignments
                                                </div>
                                            </div>
                                        </div>

                                        <!-- FlowStepItem controls -->
                                        <div class="flowstepitem-controls">
                                            <!-- Remove FlowStepItem button -->
                                            <button class="remove-step flowstepitem-remove" @onclick="(e) => RemoveFlowStepItem(flowStepIndex, flowStepItemIndex, e)" @onclick:stopPropagation="true">×</button>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }

                <!-- Action buttons -->
                <div class="workflow-actions">
                    <button class="btn-clear" @onclick="ClearConfiguration">Clear All</button>
                    <button class="btn-save" @onclick="@(() => SaveCurrentWorkflowAsync())"
                            disabled="@(!IsWorkflowValid())">
                        Save "@(!string.IsNullOrWhiteSpace(_flowName) ? _flowName : "Untitled")" Changes
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(_onSubmitMessage))
                {
                    <div class="onSubmitMessage">
                        <span class="onSubmit @(_onSubmitSuccess ? "success" : "fail")">@_onSubmitMessage</span>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Steps navbar -->
    <div class="steps-navbar">
        <div class="navbar-header">Available Steps</div>

        @foreach (StepVM step in _availableSteps)
        {
            <div class="step-info @(_draggedStep?.Id == step.Id ? "dragging" : ""))"
                 draggable="true"
                 @ondragstart="(e) => HandleDragStart(e, step)"
                 @ondragend="HandleDragEnd">

                <!-- Step description -->
                <div class="step-avatar">
                    @step.Name!.Substring(0, Math.Min(2, step.Name!.Length)).ToUpper()
                </div>
                <div class="step-details">
                    <div class="step-name">@step.Name</div>
                    <div class="step-users-count">
                        @(step.Users!.Count()) moderators
                    </div>
                </div>
            </div>
        }
    </div>
</div>