@using FlowManager.Client.ViewModels;

@if (ShowAddTeamModal)
{
    <div class="popup-backdrop" @onclick="() => ShowAddTeamModal = false">
        <div class="popup-container" @onclick:stopPropagation="true">
            <form @onsubmit="OnSubmit" @onsubmit:preventDefault="true">
                <div class="popup-header">
                    <h3>Create a new team</h3>
                </div>
                <div class="form-content">
                    <div class="team-name-input">
                        <label for="team-name">*Team Name:</label>
                        <input type="text"
                               id="team-name"
                               @bind="_teamName"
                               placeholder="Enter team name..."
                               required />
                    </div>

                    <div class="department-selector">
                        <label class="department-label">*Department:</label>
                        <div class="custom-dropdown" @onclick="ToggleDropdown">
                            <div class="dropdown-selected">
                                @(_selectedStepName ?? "Select a department")
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            @if (_isDropdownOpen)
                            {
                                <div class="dropdown-options">
                                    @foreach (StepVM step in _availableSteps)
                                    {
                                        <div class="dropdown-option" @onclick="() => SelectStep(step)" @onclick:stopPropagation="true">
                                            @step.Name
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <label class="assign-users-label">Assign users:</label>
                    <div class="search-users">
                        <input type="text"
                               @bind="_searchTerm"
                               @bind:event="oninput"
                               placeholder="Search users by name..." />
                        <button type="button" class="search-btn-users" @onclick="() => LoadUsersAsync(true)" disabled="@(IsSearchInvalid())">
                            Search
                        </button>
                    </div>

                    <div class="users-main-content">
                        <div class="users-container">
                            @for (int i = 0; i < _users.Count; i++)
                            {
                                int index = i;
                                var user = _users[index];
                                <div class="user-item @(_selectedUsers.Contains(user) ? "selected" : "")">
                                    <input type="checkbox"
                                           class="user-checkbox"
                                           id="user-@index"
                                           name="selectedUsers"
                                           value="@user.Id"
                                           checked="@_selectedUsers.Contains(user)"
                                           @onchange="(e) => ToggleUserSelection(user.Id, (bool)e.Value)" />
                                    <label for="user-@index" class="user-details">
                                        <span class="user-name">@user.Name</span>
                                        <span class="user-email">@user.Email</span>
                                    </label>
                                </div>
                            }
                        </div>

                        <!-- Assigned Users Sidebar -->
                        <div class="assigned-users-sidebar">
                            <div class="assigned-users-header">
                                <span>Assigned Users</span>
                                <div class="assigned-count">@GetAssignedUsersCount()</div>
                            </div>
                            <div class="assigned-users-list">
                                @if (GetAssignedUsers().Any())
                                {
                                    @foreach (var user in GetAssignedUsers())
                                    {
                                        <div class="assigned-user-item">
                                            <div class="assigned-user-details">
                                                <span class="assigned-user-name">@user.Name</span>
                                                <span class="assigned-user-email">@user.Email</span>
                                            </div>
                                            <button type="button"
                                                    class="remove-user-btn"
                                                    @onclick="() => RemoveUserFromAssignment(user.Id)"
                                                    title="Remove user">
                                                ✕
                                            </button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="no-assigned-users">
                                        No users assigned yet
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(_submitMessage))
                {
                    <div class="submit-message @(_submitStatus ? "success" : "fail")">
                        <span>@_submitMessage</span>
                    </div>
                }
                <div class="popup-actions">
                    <!-- Load more btn -->
                    <button type="button"
                            @onclick="() => LoadMore()"
                            disabled="@(_currentPage == _totalPages)"
                            class="load-more-button">
                        Load more
                    </button>
                    <button type="button" class="cancel-button" @onclick="OnCancel">Cancel</button>
                    <button type="submit" class="create-button" disabled="@(_isSubmitting || !IsSubmitValid())">
                        @if (_isSubmitting)
                        {
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span>Create Team</span>
                        }
                    </button>
                </div>
            </form>
        </div>
    </div>
}